name: PR Issue Validator

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-pr-issue:
    name: Validate PR Links to GitHub Issue
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
    
    steps:
      - name: Check PR for Issue Reference
        id: check_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            const prTitle = pr.title || '';
            
            // Patterns to match issue references
            const patterns = [
              /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)/gi,
              /(?:related|relates|ref|refs|references)\s+#(\d+)/gi,
              /#(\d+)/g
            ];
            
            let issueNumbers = new Set();
            
            // Check PR title and body for issue references
            const textToCheck = `${prTitle} ${prBody}`;
            
            for (const pattern of patterns) {
              const matches = textToCheck.matchAll(pattern);
              for (const match of matches) {
                issueNumbers.add(match[1]);
              }
            }
            
            console.log(`Found ${issueNumbers.size} issue reference(s): ${Array.from(issueNumbers).join(', ')}`);
            
            if (issueNumbers.size === 0) {
              // No issue reference found
              core.setOutput('has_issue', 'false');
              core.setOutput('issue_numbers', '');
              return {
                hasIssue: false,
                message: 'âŒ No GitHub issue reference found in PR title or description.'
              };
            } else {
              // Verify issues exist
              const validIssues = [];
              for (const issueNumber of issueNumbers) {
                try {
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber)
                  });
                  validIssues.push(issueNumber);
                  console.log(`âœ… Issue #${issueNumber} exists: ${issue.data.title}`);
                } catch (error) {
                  console.log(`âš ï¸ Issue #${issueNumber} not found`);
                }
              }
              
              if (validIssues.length > 0) {
                core.setOutput('has_issue', 'true');
                core.setOutput('issue_numbers', validIssues.join(','));
                return {
                  hasIssue: true,
                  issueNumbers: validIssues,
                  message: `âœ… PR is linked to ${validIssues.length} GitHub issue(s): #${validIssues.join(', #')}`
                };
              } else {
                core.setOutput('has_issue', 'false');
                core.setOutput('issue_numbers', '');
                return {
                  hasIssue: false,
                  message: 'âŒ Referenced issues do not exist in this repository.'
                };
              }
            }

      - name: Post Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const hasIssue = '${{ steps.check_issue.outputs.has_issue }}' === 'true';
            const issueNumbers = '${{ steps.check_issue.outputs.issue_numbers }}';
            const pr = context.payload.pull_request;
            
            let commentBody;
            
            if (hasIssue) {
              // Success message
              const issues = issueNumbers.split(',');
              const issueLinks = issues.map(num => `#${num}`).join(', ');
              
              commentBody = `## âœ… PR Issue Validation Passed

This Pull Request is correctly linked to GitHub issue(s): ${issueLinks}

Thank you for following our contribution guidelines! ðŸŽ‰

**Next Steps:**
- Ensure all CI checks pass
- Request code review from team members
- Address any review comments

---
*This is an automated check to ensure all PRs are linked to GitHub issues for better tracking and project management.*`;
            } else {
              // Failure message
              commentBody = `## âŒ PR Issue Validation Failed

This Pull Request **must** be linked to a GitHub issue before it can be merged.

### How to Fix This:

**Option 1: Add to PR Description**
Edit your PR description to include one of these keywords followed by the issue number:
\`\`\`
Closes #123
Fixes #123
Resolves #123
Related to #123
\`\`\`

**Option 2: Add to PR Title**
Include the issue reference in your PR title:
\`\`\`
feat: Add batch QR codes (#123)
\`\`\`

**Option 3: Reference in Commit Message**
If you've already referenced the issue in a commit message, add it to the PR description as well.

### Why This is Required:

âœ… Better project tracking and organization  
âœ… Clear context for reviewers  
âœ… Automatic issue closure when PR is merged  
âœ… Improved changelog generation  
âœ… Easier to find related changes

### Example PR Description:

\`\`\`markdown
## Description
This PR adds QR code generation for batch tracking.

## Related Issues
Closes #123

## Changes
- Added QR code generation service
- Updated batch detail page
- Added tests for QR generation

## Testing
- [ ] Tested QR code generation
- [ ] Tested QR code scanning
\`\`\`

### Need Help?

- Check our [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
- Ask in #dev-help Slack channel
- Contact your team lead

**Please update this PR to include an issue reference, then the check will automatically re-run.**

---
*This is an automated check. Every PR must be linked to a GitHub issue as per our development workflow.*`;
            }
            
            // Check if bot has already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Issue Validation')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: commentBody
              });
              console.log('Created new comment');
            }

      - name: Set Check Status
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const hasIssue = '${{ steps.check_issue.outputs.has_issue }}' === 'true';
            const issueNumbers = '${{ steps.check_issue.outputs.issue_numbers }}';
            
            const status = hasIssue ? 'success' : 'failure';
            const description = hasIssue 
              ? `Linked to issue(s): #${issueNumbers.split(',').join(', #')}` 
              : 'PR must be linked to a GitHub issue';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: status,
              context: 'PR Issue Validation',
              description: description,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md#pull-request-process`
            });
            
            if (!hasIssue) {
              core.setFailed('PR must be linked to a GitHub issue. Please update the PR description or title to include: Closes #123, Fixes #123, Resolves #123, or Related to #123');
            }

      - name: Label PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const hasIssue = '${{ steps.check_issue.outputs.has_issue }}' === 'true';
            const pr = context.payload.pull_request;
            
            if (hasIssue) {
              // Add 'has-issue' label and remove 'needs-issue' label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['has-issue']
              });
              
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: 'needs-issue'
                });
              } catch (error) {
                // Label might not exist, ignore error
              }
            } else {
              // Add 'needs-issue' label and remove 'has-issue' label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['needs-issue']
              });
              
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: 'has-issue'
                });
              } catch (error) {
                // Label might not exist, ignore error
              }
            }

