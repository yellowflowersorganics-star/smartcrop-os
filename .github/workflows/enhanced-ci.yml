name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18.x'
  DOCKER_BUILDKIT: 1

jobs:
  # ============================================
  # Code Quality Checks
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Lint Backend
        working-directory: ./backend
        run: npm run lint

      - name: Check Backend Code Format
        working-directory: ./backend
        run: |
          npm run format:check || true

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Lint Frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Check Frontend Code Format
        working-directory: ./frontend
        run: |
          npm run format:check || true

      - name: Check for Unused Dependencies
        run: |
          npx depcheck backend/ || true
          npx depcheck frontend/ || true

  # ============================================
  # Security Scanning
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: npm audit (Backend)
        working-directory: ./backend
        run: |
          npm audit --audit-level=moderate --production || true

      - name: npm audit (Frontend)
        working-directory: ./frontend
        run: |
          npm audit --audit-level=moderate --production || true

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ============================================
  # Backend Tests
  # ============================================
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: cropwise_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run Unit Tests
        working-directory: ./backend
        env:
          NODE_ENV: test
          DB_DIALECT: postgres
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: cropwise_test
          DB_USER: test_user
          DB_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test_secret_key_for_ci_pipeline
        run: npm test -- --coverage

      - name: Upload Backend Coverage
        uses: codecov/codecov-action@v3
        with:
          directory: ./backend/coverage
          flags: backend
          fail_ci_if_error: false

      - name: Check Test Coverage Threshold
        working-directory: ./backend
        run: |
          npx nyc check-coverage --lines 70 --functions 70 --branches 70 || true

  # ============================================
  # Frontend Tests
  # ============================================
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run Tests
        working-directory: ./frontend
        run: npm test -- --coverage

      - name: Upload Frontend Coverage
        uses: codecov/codecov-action@v3
        with:
          directory: ./frontend/coverage
          flags: frontend
          fail_ci_if_error: false

  # ============================================
  # E2E Tests (Optional)
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Start Services with Docker Compose
        run: |
          docker-compose up -d
          sleep 30  # Wait for services to be ready

      - name: Run E2E Tests
        run: |
          # Add your E2E test commands here
          echo "E2E tests would run here"
          # npx playwright test

      - name: Stop Services
        if: always()
        run: docker-compose down

  # ============================================
  # Build Checks
  # ============================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [code-quality, test-backend, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        working-directory: ./backend
        run: npm ci --production

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: cropwise-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [code-quality, test-frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Production
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:8080' }}
        run: npm run build

      - name: Check Build Size
        working-directory: ./frontend
        run: |
          SIZE=$(du -sh dist | cut -f1)
          echo "Build size: $SIZE"
          # Add size check if needed

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  # ============================================
  # Dependency Review
  # ============================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: true

  # ============================================
  # Performance Checks
  # ============================================
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:5173
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ============================================
  # PR Size Labeling
  # ============================================
  pr-size-labeling:
    name: PR Size Labeling
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Label PR by Size
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;
            
            let sizeLabel;
            if (changes < 10) sizeLabel = 'size: XS';
            else if (changes < 50) sizeLabel = 'size: S';
            else if (changes < 200) sizeLabel = 'size: M';
            else if (changes < 500) sizeLabel = 'size: L';
            else sizeLabel = 'size: XL';
            
            // Remove old size labels
            const oldSizeLabels = ['size: XS', 'size: S', 'size: M', 'size: L', 'size: XL'];
            for (const label of oldSizeLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: label
                });
              } catch (error) {
                // Label doesn't exist, ignore
              }
            }
            
            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });
            
            console.log(`Labeled PR with: ${sizeLabel} (${changes} lines changed)`);

  # ============================================
  # Status Check Summary
  # ============================================
  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [
      code-quality,
      security-scan,
      test-backend,
      test-frontend,
      build-backend,
      build-frontend
    ]
    if: always()
    
    steps:
      - name: Check All Jobs Status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              '${{ needs.code-quality.result }}',
              '${{ needs.security-scan.result }}',
              '${{ needs.test-backend.result }}',
              '${{ needs.test-frontend.result }}',
              '${{ needs.build-backend.result }}',
              '${{ needs.build-frontend.result }}'
            ];
            
            const failed = jobs.filter(job => job === 'failure');
            const cancelled = jobs.filter(job => job === 'cancelled');
            
            if (failed.length > 0) {
              core.setFailed(`${failed.length} job(s) failed`);
            } else if (cancelled.length > 0) {
              core.setFailed(`${cancelled.length} job(s) were cancelled`);
            } else {
              console.log('‚úÖ All CI checks passed!');
            }

      - name: Post Summary Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const results = {
              'Code Quality': '${{ needs.code-quality.result }}',
              'Security Scan': '${{ needs.security-scan.result }}',
              'Backend Tests': '${{ needs.test-backend.result }}',
              'Frontend Tests': '${{ needs.test-frontend.result }}',
              'Backend Build': '${{ needs.build-backend.result }}',
              'Frontend Build': '${{ needs.build-frontend.result }}'
            };
            
            const getEmoji = (status) => {
              if (status === 'success') return '‚úÖ';
              if (status === 'failure') return '‚ùå';
              if (status === 'cancelled') return '‚èπÔ∏è';
              return '‚è≠Ô∏è';
            };
            
            let summary = '## üîç CI/CD Pipeline Results\n\n';
            for (const [name, status] of Object.entries(results)) {
              summary += `${getEmoji(status)} **${name}**: ${status}\n`;
            }
            
            const allPassed = Object.values(results).every(r => r === 'success');
            
            if (allPassed) {
              summary += '\n---\n\n‚úÖ **All checks passed!** This PR is ready for review.';
            } else {
              summary += '\n---\n\n‚ùå **Some checks failed.** Please review the failed jobs above.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });

