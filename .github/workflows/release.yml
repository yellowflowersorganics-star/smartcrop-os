name: Release

on:
  push:
    tags:
      - 'v*'

env:
  NODE_VERSION: '18.x'

jobs:
  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract Changelog
        id: changelog
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          CHANGELOG=$(awk "/## \[${VERSION}\]/,/## \[/" CHANGELOG.md | head -n -1)
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: SmartCrop OS ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## üöÄ SmartCrop OS ${{ steps.get_version.outputs.VERSION }}
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ---
            
            ### üì¶ Installation
            
            ```bash
            # Clone the repository
            git clone https://github.com/your-org/smartcrop-os.git
            git checkout ${{ steps.get_version.outputs.VERSION }}
            
            # Install dependencies
            cd backend && npm install
            cd ../frontend && npm install
            
            # Start the application
            npm run dev
            ```
            
            ### üê≥ Docker
            
            ```bash
            docker pull smartcrop/backend:${{ steps.get_version.outputs.VERSION }}
            docker pull smartcrop/frontend:${{ steps.get_version.outputs.VERSION }}
            ```
            
            ### üìö Documentation
            
            - [Release Notes](https://github.com/your-org/smartcrop-os/releases/tag/${{ steps.get_version.outputs.VERSION }})
            - [API Documentation](https://docs.smartcrop.io)
            - [Deployment Guide](https://github.com/your-org/smartcrop-os/blob/main/docs/AWS_DEPLOYMENT_GUIDE.md)
            
            ### üêõ Found a bug?
            
            Please [report it](https://github.com/your-org/smartcrop-os/issues/new?template=bug_report.md)
          draft: false
          prerelease: false

  # ============================================
  # Build and Push Docker Images
  # ============================================
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            smartcrop/backend:latest
            smartcrop/backend:${{ steps.get_version.outputs.VERSION }}
          cache-from: type=registry,ref=smartcrop/backend:buildcache
          cache-to: type=registry,ref=smartcrop/backend:buildcache,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: |
            smartcrop/frontend:latest
            smartcrop/frontend:${{ steps.get_version.outputs.VERSION }}
          cache-from: type=registry,ref=smartcrop/frontend:buildcache
          cache-to: type=registry,ref=smartcrop/frontend:buildcache,mode=max

  # ============================================
  # Deploy to Production
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: https://www.smartcrop.io
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ap-south-1

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update ECS Task Definition
        run: |
          # Update backend task definition with new image version
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition smartcrop-backend-prod \
            --query 'taskDefinition' \
            --output json)
          
          NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | \
            jq --arg VERSION "${{ steps.get_version.outputs.VERSION }}" \
            '.containerDefinitions[0].image = "smartcrop/backend:" + $VERSION')
          
          aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEFINITION"

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster smartcrop-prod-cluster \
            --service smartcrop-backend-prod \
            --force-new-deployment \
            --desired-count 2

      - name: Wait for deployment to complete
        run: |
          aws ecs wait services-stable \
            --cluster smartcrop-prod-cluster \
            --services smartcrop-backend-prod

      - name: Deploy Frontend to S3
        run: |
          # Frontend is already built in Docker image
          # Extract and deploy to S3
          docker create --name frontend-temp smartcrop/frontend:${{ steps.get_version.outputs.VERSION }}
          docker cp frontend-temp:/usr/share/nginx/html ./dist
          docker rm frontend-temp
          
          aws s3 sync ./dist s3://smartcrop-prod-frontend --delete

      - name: Invalidate CloudFront
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.CLOUDFRONT_PROD_DISTRIBUTION_ID }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_PROD_DISTRIBUTION_ID }} \
              --paths "/*"
          else
            echo "CloudFront distribution ID not set, skipping cache invalidation"
          fi

      - name: Run Health Checks
        run: |
          echo "Running production health checks..."
          
          # Backend health check
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api.smartcrop.io/health)
            if [ $HTTP_CODE -eq 200 ]; then
              echo "‚úÖ Backend health check passed"
              break
            fi
            echo "‚è≥ Waiting for backend... ($i/5)"
            sleep 10
          done
          
          # Frontend health check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://www.smartcrop.io)
          if [ $HTTP_CODE -eq 200 ]; then
            echo "‚úÖ Frontend health check passed"
          else
            echo "‚ùå Frontend health check failed"
            exit 1
          fi

      - name: Notify Team (Slack)
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "üöÄ SmartCrop OS ${{ steps.get_version.outputs.VERSION }} deployed to PRODUCTION",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéâ Production Release Deployed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ steps.get_version.outputs.VERSION }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*URL:*\n<https://www.smartcrop.io|SmartCrop OS>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release Notes"
                      },
                      "url": "https://github.com/your-org/smartcrop-os/releases/tag/v${{ steps.get_version.outputs.VERSION }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Changes"
                      },
                      "url": "https://github.com/your-org/smartcrop-os/compare/v${{ steps.get_version.outputs.VERSION }}...HEAD"
                    }
                  ]
                }
              ]
            }

      - name: Notify on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "‚ùå SmartCrop OS ${{ steps.get_version.outputs.VERSION }} deployment FAILED",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Production Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Version *${{ steps.get_version.outputs.VERSION }}* failed to deploy to production. Please investigate immediately."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  # ============================================
  # Update Documentation
  # ============================================
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update version in README
        run: |
          sed -i "s/Version: .*/Version: ${{ steps.get_version.outputs.VERSION }}/" README.md

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "docs: update version to ${{ steps.get_version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"

